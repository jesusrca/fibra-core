// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL") // Recommended for Supabase
}

enum Role {
  ADMIN
  GERENCIA
  CONTABILIDAD
  FINANZAS
  PROYECTOS
  MARKETING
  COMERCIAL
}

enum ProjectStatus {
  PLANNING
  ACTIVE
  REVIEW
  COMPLETED
  ON_HOLD
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  PROPOSAL
  WON
  LOST
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}

enum TransactionCategory {
  INCOME
  EXPENSE
  TRANSFER
}

model User {
  id            String    @id @default(cuid())
  name          String
  email         String    @unique
  avatarUrl     String?
  passwordHash  String?
  phone         String?
  role          Role      @default(COMERCIAL)
  telegramId    String?   @unique
  specialty     String?
  birthday      DateTime?
  country       String?
  timezone      String?
  schedule      String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  assignedProjects Project[] @relation("ProjectTeam")
  directedProjects Project[] @relation("ProjectDirector")
  tasks            Task[]
  payrollRecords   Payroll[]
  notifications    Notification[]
  reports          Report[]
  toolAuditLogs    ToolAuditLog[]
  emailIntegrations EmailIntegration[]
  passwordResetTokens PasswordResetToken[]
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String
  message   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId, read, createdAt])
}

model Report {
  id            String   @id @default(cuid())
  name          String
  type          String
  format        String   @default("JSON")
  status        String   @default("READY")
  periodStart   DateTime
  periodEnd     DateTime
  periodLabel   String?
  summary       Json?
  content       String?
  generatedById String
  generatedBy   User     @relation(fields: [generatedById], references: [id], onDelete: Cascade)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([generatedById, createdAt])
}

model ToolAuditLog {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  toolName  String
  action    String
  inputJson Json?
  success   Boolean
  error     String?
  createdAt DateTime @default(now())

  @@index([userId, createdAt])
  @@index([toolName, createdAt])
}

model Client {
  id              String    @id @default(cuid())
  name            String
  country         String?
  industry        String?
  taxId           String?   // RUC
  address         String?
  referredBy      String?
  mainEmail       String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  contacts        Contact[]
  projects        Project[]
  leads           Lead[]
  invoices        Invoice[]
}

model Contact {
  id              String    @id @default(cuid())
  firstName       String
  lastName        String
  email           String
  phone           String?
  contactMethod   String?
  country         String?
  specialty       String?
  clientId        String
  client          Client    @relation(fields: [clientId], references: [id])
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  leads           Lead[]
  projects        Project[] @relation("ProjectContact")
  activities      Activity[]
  emailMessages   EmailMessage[]
}

model Project {
  id              String        @id @default(cuid())
  name            String
  inboxEmail      String?       @unique
  clientId        String
  client          Client        @relation(fields: [clientId], references: [id])
  contactId       String?
  contact         Contact?      @relation("ProjectContact", fields: [contactId], references: [id])
  directorId      String
  director        User          @relation("ProjectDirector", fields: [directorId], references: [id])
  startDate       DateTime?
  endDate         DateTime?
  status          ProjectStatus @default(PLANNING)
  budget          Float         @default(0)
  serviceType     String?
  milestonesCount Int           @default(0)
  quoteId         String?       // Reference to original quote
  quote           Quote?         @relation(fields: [quoteId], references: [id])
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  team            User[]        @relation("ProjectTeam")
  tasks           Task[]
  invoices        Invoice[]
  transactions    Transaction[]
  milestones      Milestone[]
  suppliers       SupplierWork[]
  emailMessages   EmailMessage[]
}

model Milestone {
  id          String   @id @default(cuid())
  name        String
  description String?
  dueDate     DateTime?
  status      String   @default("PENDING")
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id])
}

model Lead {
  id                  String     @id @default(cuid())
  companyName         String?
  clientId            String?
  client              Client?    @relation(fields: [clientId], references: [id])
  contactId           String?
  contact             Contact?   @relation(fields: [contactId], references: [id])
  serviceRequested    String?
  requirementDetail   String?    @db.Text
  estimatedValue      Float      @default(0)
  currency            String     @default("USD")
  quoteNumber         String?
  status              LeadStatus @default(NEW)
  source              String?
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Relations
  activities          Activity[]
  quotes              Quote[]
}

model Activity {
  id          String   @id @default(cuid())
  type        String   // Call, Email, Meeting, Chat
  description String   @db.Text
  date        DateTime @default(now())
  leadId      String
  lead        Lead     @relation(fields: [leadId], references: [id])
  contactId   String?
  contact     Contact? @relation(fields: [contactId], references: [id])
}

model Quote {
  id                String   @id @default(cuid())
  leadId            String
  lead              Lead     @relation(fields: [leadId], references: [id])
  proposalDetail    String?  @db.Text
  servicesOffered   String?  @db.Text
  budget            Float
  paymentMethod     String?
  paymentCountry    String?
  sentDate          DateTime?
  acceptedDate      DateTime?
  rejectedDate      DateTime?
  status            String   @default("PENDING")
  installmentsCount Int      @default(1)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  projects          Project[]
  invoices          Invoice[]
}

model Invoice {
  id              String        @id @default(cuid())
  invoiceNumber   String        @unique
  fileUrl         String?
  clientId        String
  client          Client        @relation(fields: [clientId], references: [id])
  projectId       String?
  project         Project?      @relation(fields: [projectId], references: [id])
  quoteId         String?
  quote           Quote?        @relation(fields: [quoteId], references: [id])
  issueDate       DateTime      @default(now())
  dueDate         DateTime?
  amount          Float
  status          InvoiceStatus @default(DRAFT)
  paymentMethod   String?
  paymentCountry  String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  transactions    Transaction[]
}

model Task {
  id          String   @id @default(cuid())
  title       String
  description String?  @db.Text
  status      String   @default("TODO")
  priority    String   @default("MEDIUM")
  startDate   DateTime?
  dueDate     DateTime?
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id])
  assigneeId  String?
  assignee    User?    @relation(fields: [assigneeId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Transaction {
  id          String              @id @default(cuid())
  date        DateTime            @default(now())
  category    TransactionCategory @default(EXPENSE)
  subcategory String?             // Marketing, Office, Salary, etc.
  currency    String              @default("PEN")
  bank        String?
  amount      Float
  description String?
  receiptUrl  String?             // Link to Supabase Storage
  invoiceId   String?
  invoice     Invoice?            @relation(fields: [invoiceId], references: [id])
  projectId   String?
  project     Project?            @relation(fields: [projectId], references: [id])
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
}

model AccountingBank {
  id        String   @id @default(cuid())
  name      String   @unique
  code      String?
  supportedCurrencies String[] @default(["PEN", "USD"])
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive, name])
}

model FixedCost {
  id          String   @id @default(cuid())
  name        String
  amount      Float
  category    String   // Rent, Services, Subscriptions, etc.
  dueDate     DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Payroll {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  salary      Float
  bonus       Float    @default(0)
  status      String   @default("PENDING") // PAID, PENDING
  paymentDate DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Supplier {
  id              String         @id @default(cuid())
  name            String
  category        String?        // Imprenta, Log√≠stica, IT, etc.
  city            String?
  country         String?
  rating          Float          @default(0)
  contactName     String?
  contactEmail    String?
  contactPhone    String?
  status          String         @default("ACTIVE")
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  works           SupplierWork[]
}

model SupplierWork {
  id                String   @id @default(cuid())
  supplierId        String?
  supplier          Supplier? @relation(fields: [supplierId], references: [id])
  supplierName      String   // Fallback or legacy
  serviceProvided   String
  totalBudget       Float
  installmentsCount Int      @default(1)
  projectId         String
  project           Project  @relation(fields: [projectId], references: [id])
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  payments          SupplierPayment[]
}

model SupplierPayment {
  id             String       @id @default(cuid())
  supplierWorkId String
  supplierWork   SupplierWork @relation(fields: [supplierWorkId], references: [id])
  amount         Float
  status         String       @default("PENDING")
  issueDate      DateTime?
  paymentDate    DateTime?
  receiptUrl     String?      // Link to file
  description    String?
}

model ServiceCatalog {
  id           String   @id @default(cuid())
  name         String   @unique
  description  String?  @db.Text
  averagePrice Float    @default(0)
  currency     String   @default("USD")
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([isActive, name])
}

model SocialMetric {
  id           String   @id @default(cuid())
  platform     String
  followers    Int      @default(0)
  impressions  Int      @default(0)
  interactions Int      @default(0)
  clicks       Int      @default(0)
  leads        Int      @default(0)
  recordedAt   DateTime @default(now())
  notes        String?  @db.Text
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([platform, recordedAt])
}

model EmailIntegration {
  id             String   @id @default(cuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  provider       String   @default("gmail")
  accountEmail   String
  accessToken    String?
  refreshToken   String?
  tokenExpiresAt DateTime?
  isActive       Boolean  @default(true)
  lastSyncAt     DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  messages       EmailMessage[]

  @@unique([userId, provider, accountEmail])
  @@index([userId, isActive])
}

model EmailMessage {
  id            String            @id @default(cuid())
  integrationId String
  integration   EmailIntegration  @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  externalId    String
  threadId      String?
  fromEmail     String
  toEmails      String?
  subject       String?
  snippet       String?
  bodyText      String?
  receivedAt    DateTime
  contactId     String?
  contact       Contact?          @relation(fields: [contactId], references: [id], onDelete: SetNull)
  projectId     String?
  project       Project?          @relation(fields: [projectId], references: [id], onDelete: SetNull)
  metadata      Json?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  @@unique([integrationId, externalId])
  @@index([receivedAt, contactId, projectId])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tokenHash String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  @@index([userId, expiresAt])
}
